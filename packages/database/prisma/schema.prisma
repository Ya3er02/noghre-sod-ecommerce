// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id                 String           @id @default(cuid())
  email              String           @unique
  firstName          String?
  lastName           String?
  passwordHash       String?
  isVerified         Boolean          @default(false)
  role               UserRole         @default(CUSTOMER)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  deletedAt          DateTime?

  // Relations
  profile            Profile?
  orders             Order[]
  priceAlerts        PriceAlert[]
  addresses          Address[]
  auditLog           AuditLog[]

  @@index([email])
  @@index([role])
}

model Profile {
  id                 String           @id @default(cuid())
  userId             String           @unique
  phoneNumber        String?
  bio                String?
  avatarUrl          String?
  preferredLanguage  String           @default("en")
  notificationEmail  Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Address {
  id                 String           @id @default(cuid())
  userId             String
  street             String
  city               String
  state              String
  postalCode         String
  country            String
  isDefault          Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPPORT
}

// ============================================
// PRODUCT & CATALOG MODELS
// ============================================

model Product {
  id                 String           @id @default(cuid())
  sku                String           @unique
  name               String
  description        String?
  category           ProductCategory
  purity             String           // e.g., "999.9", "925", "900"
  weight             Float            // in grams
  basePrice          Float            // Cost price in USD
  marginPercent      Float            @default(5.0)
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  prices             Price[]
  orderItems         OrderItem[]
  inventories        Inventory[]

  @@index([category])
  @@index([isActive])
}

enum ProductCategory {
  BAR
  COIN
  JEWELRY
  BULLION
  COLLECTIBLE
}

model Inventory {
  id                 String           @id @default(cuid())
  productId          String
  quantity           Int              @default(0)
  warehouseLocation  String?
  lastRestocked      DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  product            Product          @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId])
  @@index([quantity])
}

// ============================================
// PRICING MODELS
// ============================================

model Price {
  id                 String           @id @default(cuid())
  productId          String
  silverSpotPrice    Float            // Current market spot price (USD/oz)
  ourPrice           Float            // Our selling price (USD/g)
  margin             Float            // Calculated margin
  source             String           @default("metals.live")
  timestamp          DateTime         @default(now())

  product            Product          @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([timestamp])
}

model PriceHistory {
  id                 String           @id @default(cuid())
  silverSpotPrice    Float
  averagePrice       Float
  highPrice          Float
  lowPrice           Float
  recordedAt         DateTime         @default(now())
  source             String           @default("metals.live")

  @@index([recordedAt])
}

model PriceAlert {
  id                 String           @id @default(cuid())
  userId             String
  productId          String?
  triggerPrice       Float
  triggerType        TriggerType      // ABOVE or BELOW
  isActive           Boolean          @default(true)
  notificationSent   Boolean          @default(false)
  sentAt             DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

enum TriggerType {
  ABOVE
  BELOW
}

// ============================================
// ORDER & TRANSACTION MODELS
// ============================================

model Order {
  id                 String           @id @default(cuid())
  userId             String
  orderNumber        String           @unique @default(cuid())
  status             OrderStatus      @default(PENDING)
  totalAmount        Float
  discountAmount     Float            @default(0)
  taxAmount          Float            @default(0)
  shippingCost       Float            @default(0)
  finalAmount        Float
  paymentStatus      PaymentStatus    @default(UNPAID)
  shippingStatus     ShippingStatus   @default(NOT_SHIPPED)
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user               User             @relation(fields: [userId], references: [id])
  items              OrderItem[]
  payment            Payment?
  shipment           Shipment?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                 String           @id @default(cuid())
  orderId            String
  productId          String
  quantity           Int
  unitPrice          Float
  subtotal           Float
  createdAt          DateTime         @default(now())

  order              Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product          @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id                 String           @id @default(cuid())
  orderId            String           @unique
  amount             Float
  currency           String           @default("USD")
  paymentMethod      PaymentMethod
  transactionId      String?
  status             PaymentStatus    @default(UNPAID)
  failureReason      String?
  processedAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  order              Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PAYPAL
  CRYPTO
}

model Shipment {
  id                 String           @id @default(cuid())
  orderId            String           @unique
  trackingNumber     String?
  carrier            String?
  estimatedDelivery  DateTime?
  actualDelivery     DateTime?
  status             ShippingStatus   @default(NOT_SHIPPED)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  order              Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  UNPAID
  PROCESSING
  PAID
  FAILED
  REFUNDED
}

enum ShippingStatus {
  NOT_SHIPPED
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

// ============================================
// AI & INTELLIGENCE MODELS
// ============================================

model AIAdvisor {
  id                 String           @id @default(cuid())
  sessionId          String
  userId             String?
  query              String
  response           String
  sentiment          String?          // POSITIVE, NEUTRAL, NEGATIVE
  confidence         Float?           // 0-1 confidence score
  model              String           @default("gemini-1.5-flash")
  tokensUsed         Int?             // For cost tracking
  fallbackUsed       Boolean          @default(false)
  createdAt          DateTime         @default(now())

  @@index([userId])
  @@index([createdAt])
}

model TrendAnalysis {
  id                 String           @id @default(cuid())
  period             String           // "1H", "1D", "7D", "30D", "1Y"
  trendDirection     String           // "UP", "DOWN", "STABLE"
  averagePrice       Float
  highPrice          Float
  lowPrice           Float
  volatility         Float?           // Standard deviation
  analysis           String?
  generatedAt        DateTime         @default(now())

  @@index([period])
  @@index([generatedAt])
}

// ============================================
// AUDIT & LOGGING MODELS
// ============================================

model AuditLog {
  id                 String           @id @default(cuid())
  userId             String
  action             String
  entity             String
  entityId           String?
  changes            Json?
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime         @default(now())

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
