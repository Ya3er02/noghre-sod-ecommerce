name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # Deploy Frontend to Liara
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://noghresood.shop
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.1.0'

      - name: Install dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Build production
        working-directory: ./frontend
        run: bun run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL_PROD }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY_PROD }}
          VITE_APP_ENV: production

      - name: Deploy to Liara
        uses: liara-cloud/liara-action@v1
        with:
          api-token: ${{ secrets.LIARA_API_TOKEN }}
          app-name: noghre-sood-frontend
          port: 3000
          build-location: ./frontend/dist

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://noghresood.shop || exit 1

  # Deploy Backend with Encore
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://api.noghresood.shop
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Encore CLI
        run: |
          curl -L https://encore.dev/install.sh | bash
          echo "$HOME/.encore/bin" >> $GITHUB_PATH

      - name: Authenticate Encore
        run: encore auth login --token ${{ secrets.ENCORE_AUTH_TOKEN }}

      - name: Deploy to Encore Cloud
        working-directory: ./backend
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            encore deploy --env staging
          else
            encore deploy --env production
          fi

      - name: Run database migrations
        working-directory: ./backend
        run: encore db migrate --env production

  # Post-deployment tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test frontend health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://noghresood.shop)
          if [ $response -ne 200 ]; then
            echo "Frontend health check failed with status $response"
            exit 1
          fi
          echo "✅ Frontend is healthy"

      - name: Test backend health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.noghresood.shop/health)
          if [ $response -ne 200 ]; then
            echo "Backend health check failed with status $response"
            exit 1
          fi
          echo "✅ Backend is healthy"

      - name: Test critical endpoints
        run: |
          # Test products endpoint
          curl -f https://api.noghresood.shop/products || exit 1
          
          # Test silver price endpoint
          curl -f https://api.noghresood.shop/prices/silver || exit 1
          
          echo "✅ All critical endpoints are working"

  # Notify deployment
  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
            echo "Frontend: https://noghresood.shop"
            echo "Backend: https://api.noghresood.shop"
            echo "Deployed by: ${{ github.actor }}"
            echo "Commit: ${{ github.sha }}"
          else
            echo "❌ Deployment failed or incomplete"
            exit 1
          fi

      # Optional: Send to Slack/Discord/Email
      - name: Send Slack notification
        if: success()
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "✅ Noghre Sood deployed successfully!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status:* Success\n*Environment:* ${{ github.event.inputs.environment || 'production' }}\n*Deployed by:* ${{ github.actor }}\n*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
